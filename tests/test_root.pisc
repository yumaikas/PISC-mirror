/* Tests for various bits of PISC */

:DOC assert ( message quot1 quot2 -- ) 
	Use eq to assert that both quotations result in the same test result
;
/*
: assert ( message quot1 quot2 -- ) :q2 :q1 :msg
 	{ q1 } { q2 } eq not [ $msg error ] when
;
*/

:DOC assert-deep-slow ( message quot1 quot2 -- ) 
	Use deep-slow-reflect-eq to assert both quotoations result in the same test result 
;

: assert ( message quot1 quot2 -- ) 
	:q2 :q1 :msg 
 	{ q1 } dup :a1 { q2 } dup :a2 deep-slow-reflect-eq not [ 
	 	${ "Testing that " $msg " failed: " $a1 " is not " $a2 } print
 	 ] [
	 	"." print
 	 ] if 
 	# Indicate that we passed the assert
;


: run-single-test ( name quot -- test ) 
	:quot :name
	${ "Running: " $name } print
	{ quot } dup :arr len 0 > [ ${ "Test" $name "corrupted the stack with" arr } error ] when
;

: <test-suite> ( name -- suite ) 
	<vector> :tests
	<dict> dup :self
		swap -:name

		[ $tests ] -:tests

		/* ( name quot -- ) */
		[ 2vector $tests swap vec-append :tests ] -:addTest

		[ 
			${ "Running the " $self -$name " tests" } print
			$tests [ splat run-single-test ] vec-each
		] -:runTests
;


# This is the test section

"Math" <test-suite> :basic-suite

"Addition" [
	"3 + 3 should be 6" [ 3 3 + ] [ 6 ] assert
	"2 + 1 should be 3" [ 2 1 + ] [ 3 ] assert
 ] $basic-suite .addTest

"Subtraction" [
	"2 - 1 should be 1" [ 2 1 - ] [ 1 ] assert
	"5 - 3 should be 2" [ 5 3 - ] [ 2 ] assert 
	"8 - 3 should be 5" [ 8 3 - ] [ 5 ] assert 
	"8 - 3 should be 5" [ 8 3 - ] [ 5 ] assert 
	"8 - 3 should be 5" [ 8 3 - ] [ 5 ] assert 
] $basic-suite .addTest

"phail" [
	"this should have" /* failed */ [ 2 ] [ 4 ] assert
] $basic-suite .addTest

$basic-suite .runTests
